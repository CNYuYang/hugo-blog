<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Lab2 Hash Index ::
        ä½™ä¸ºæ°‘åŒå¿—|åšä¸€ä¸ªä¼˜ç§€çš„æ™®é€šäººï¼Œåœ¨çƒ­çˆ±ä¸­ç‡ƒçƒ§ï¼
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="åœ¨fall2019çš„ç‰ˆæœ¬ä¸­éœ€è¦å®ç°çš„hash tableçš„æµ‹è¯•ä»£ç (hash_table_page_test.cppã€hash_table_test.cpp)å·²ç»è¢«æ³¨é‡Šæ‰äº†ï¼Œæ‰€ä»¥è¿™é‡Œå®ç°çš„æ˜¯fall2023ç‰ˆæœ¬ä¸­çš„å¯æ‰©å±•å“ˆå¸Œã€‚å¼•ç”¨æ­¤å‰ç¬”è®°ä¸­çš„å†…å®¹ï¼Œå±•ç¤ºå¯æ‰©å±•å“ˆå¸Œçš„ç»“æ„ï¼š ä½†æ˜¯åœ¨è¯¥é¡¹ç›®å®ç°ä¸­ï¼Œéœ€è¦è¿˜æœ‰ä¸€ä¸ª"
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://yuyang.run/posts/cmu15-445%E5%AE%9E%E9%AA%8C/lab2-hash-index/" />







<link rel="stylesheet" href="/css/style.css" />

<link rel="stylesheet" href="https://yuyang.run/style.css" />


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://yuyang.run/img/apple-touch-icon-144-precomposed.png" />
<link rel="shortcut icon" href="https://yuyang.run/img/favicon.png" />




<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Lab2 Hash Index"/>
<meta name="twitter:description" content="åœ¨fall2019çš„ç‰ˆæœ¬ä¸­éœ€è¦å®ç°çš„hash tableçš„æµ‹è¯•ä»£ç (hash_table_page_test.cppã€hash_table_test.cpp)å·²ç»è¢«æ³¨é‡Šæ‰äº†ï¼Œæ‰€ä»¥è¿™é‡Œå®ç°çš„æ˜¯fall2023ç‰ˆæœ¬ä¸­çš„å¯æ‰©å±•å“ˆå¸Œã€‚å¼•ç”¨æ­¤å‰ç¬”è®°ä¸­çš„å†…å®¹ï¼Œå±•ç¤ºå¯æ‰©å±•å“ˆå¸Œçš„ç»“æ„ï¼š ä½†æ˜¯åœ¨è¯¥é¡¹ç›®å®ç°ä¸­ï¼Œéœ€è¦è¿˜æœ‰ä¸€ä¸ª"/>



<meta property="og:title" content="Lab2 Hash Index" />
<meta property="og:description" content="åœ¨fall2019çš„ç‰ˆæœ¬ä¸­éœ€è¦å®ç°çš„hash tableçš„æµ‹è¯•ä»£ç (hash_table_page_test.cppã€hash_table_test.cpp)å·²ç»è¢«æ³¨é‡Šæ‰äº†ï¼Œæ‰€ä»¥è¿™é‡Œå®ç°çš„æ˜¯fall2023ç‰ˆæœ¬ä¸­çš„å¯æ‰©å±•å“ˆå¸Œã€‚å¼•ç”¨æ­¤å‰ç¬”è®°ä¸­çš„å†…å®¹ï¼Œå±•ç¤ºå¯æ‰©å±•å“ˆå¸Œçš„ç»“æ„ï¼š ä½†æ˜¯åœ¨è¯¥é¡¹ç›®å®ç°ä¸­ï¼Œéœ€è¦è¿˜æœ‰ä¸€ä¸ª" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yuyang.run/posts/cmu15-445%E5%AE%9E%E9%AA%8C/lab2-hash-index/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-27T20:40:00+08:00" />
<meta property="article:modified_time" content="2023-12-27T20:40:00+08:00" />








  </head>
  <body class="light-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="https://yuyang.run"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >ä½™ä¸ºæ°‘åŒå¿—</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/posts/">æ–‡ç« </a></li>
        
      
        
          <li><a href="/tags/">æ ‡ç­¾</a></li>
        
      
        
          <li><a href="/categories/">åˆ†ç±»</a></li>
        
      
        
          <li><a href="https://geekbang.yuyang.run">æå®¢å¸®</a></li>
        
      
        
          <li><a href="/about/">å…³äºæˆ‘</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/posts/">æ–‡ç« </a></li>
      
    
      
        <li><a href="/tags/">æ ‡ç­¾</a></li>
      
    
      
        <li><a href="/categories/">åˆ†ç±»</a></li>
      
    
      
        <li><a href="https://geekbang.yuyang.run">æå®¢å¸®</a></li>
      
    
      
        <li><a href="/about/">å…³äºæˆ‘</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <article class="post">
    
    
        <div style="position: fixed; right:10px; overflow:auto; top: 100px; width: 22%; bottom:50px">
          <h2>ç›®å½•</h2>
          <aside class="table-of-contents"><nav id="TableOfContents">
  <ul>
    <li><a href="#è¯»å†™é¡µé¢å«å…µ">è¯»/å†™é¡µé¢å«å…µ</a>
      <ul>
        <li><a href="#ç§»åŠ¨æ„é€ å‡½æ•°ç§»åŠ¨èµ‹å€¼è¯­å¥">ç§»åŠ¨æ„é€ å‡½æ•°&amp;ç§»åŠ¨èµ‹å€¼è¯­å¥</a></li>
        <li><a href="#ææ„å‡½æ•°drop">ææ„å‡½æ•°&amp;Drop</a></li>
        <li><a href="#upgradereadupgradewrite">UpgradeRead&amp;UpgradeWrite</a></li>
      </ul>
    </li>
    <li><a href="#å¯æ‰©å±•å“ˆå¸Œé¡µé¢å®ç°">å¯æ‰©å±•å“ˆå¸Œé¡µé¢å®ç°</a>
      <ul>
        <li><a href="#headeré¡µå®ç°">Headeré¡µå®ç°</a></li>
        <li><a href="#directoryé¡µå®ç°">Directoryé¡µå®ç°</a></li>
        <li><a href="#bucketé¡µå®ç°">Bucketé¡µå®ç°</a></li>
      </ul>
    </li>
    <li><a href="#å¯æ‰©å±•å“ˆå¸Œå®ç°">å¯æ‰©å±•å“ˆå¸Œå®ç°</a></li>
    <li><a href="#å¹¶å‘æ§åˆ¶">å¹¶å‘æ§åˆ¶</a></li>
  </ul>
</nav></aside>
        </div>
      
    
    <div class="in-article">
      
        <figure class="post-cover">
  
    <img src="https://yuyang.run/cover/database.png" alt="Lab2 Hash Index"/>
  

  
</figure>

      
    </div>
    <h1 class="post-title">Lab2 Hash Index</h1>
    <div class="post-meta">
      
        <time class="post-date">
          2023-12-27 20:40:00
        </time>

        
          
        
      

      


      
    </div>

    
      <span class="post-tags">
        
          <a href="https://yuyang.run/tags/cmu15-445/">#CMU15-445</a>&nbsp;
        
          <a href="https://yuyang.run/tags/sql/">#SQL</a>&nbsp;
        
      </span>
    

    <div class="post-content">

      <p>åœ¨fall2019çš„ç‰ˆæœ¬ä¸­éœ€è¦å®ç°çš„hash tableçš„æµ‹è¯•ä»£ç (<code>hash_table_page_test.cpp</code>ã€<code>hash_table_test.cpp</code>)å·²ç»è¢«æ³¨é‡Šæ‰äº†ï¼Œæ‰€ä»¥è¿™é‡Œå®ç°çš„æ˜¯fall2023ç‰ˆæœ¬ä¸­çš„å¯æ‰©å±•å“ˆå¸Œã€‚å¼•ç”¨æ­¤å‰ç¬”è®°ä¸­çš„å†…å®¹ï¼Œå±•ç¤ºå¯æ‰©å±•å“ˆå¸Œçš„ç»“æ„ï¼š</p>
<p><img src="/images/15445/06-16.png" alt=""></p>
<p><strong>ä½†æ˜¯åœ¨è¯¥é¡¹ç›®å®ç°ä¸­ï¼Œéœ€è¦è¿˜æœ‰ä¸€ä¸ªheaderçš„ç»“æ„ï¼Œæ ¹æ®hashå€¼çš„å‰2ä½åˆ†é…åˆ°ä¸åŒçš„directoryï¼š</strong></p>
<p><img src="/images/15445/lab2-00.svg" alt=""></p>
<h2 id="è¯»å†™é¡µé¢å«å…µ">
  è¯»/å†™é¡µé¢å«å…µ
  <a href="#%e8%af%bb%e5%86%99%e9%a1%b5%e9%9d%a2%e5%8d%ab%e5%85%b5" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>ğŸ”—ä»£ç é“¾æ¥ï¼š<a href="https://gitee.com/cnyuyang/bustub/blob/master/src/storage/page/page_guard.cpp" target="_blank">https://gitee.com/cnyuyang/bustub/blob/master/src/storage/page/page_guard.cpp</a>
</p>
<p>è¯¥Taskçš„ç›®çš„æ˜¯ï¼šå¦‚æœç¨‹åºå‘˜å¿˜è®°è°ƒç”¨<code>UnpinPage</code>ï¼Œé¡µé¢å°†æ°¸è¿œä¸ä¼šè¢«ä»ç¼“å†²æ± ä¸­é©±é€å‡ºå»ã€‚å¯¼è‡´ç¼“å†²æ± ä»¥æ›´å°‘çš„å¸§æ•°é‡è¿è¡Œï¼Œå› æ­¤å°†æœ‰æ›´å¤šçš„é¡µäº¤æ¢è¿›å‡ºç£ç›˜ã€‚ä¸ä»…æ€§èƒ½å—åˆ°å½±å“ï¼ŒBUGä¹Ÿå¾ˆéš¾è¢«å‘ç°ã€‚è€Œè¿™ä¸ªå«å…µçš„ä½œç”¨åˆ™æ˜¯ï¼šåˆ›å»ºé¡µé¢å«å…µä¸ºå±€éƒ¨å˜é‡ï¼Œ<strong>å½“ç¦»å¼€ä½œç”¨åŸŸæ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œææ„å‡½æ•°ï¼Œåœ¨ææ„å‡½æ•°ä¸­ä¾¿å¯ä»¥è°ƒç”¨é¡µé¢çš„<code>UnpinPage</code>æ–¹æ³•ï¼Œå¸®åŠ©ç¨‹åºå‘˜è‡ªåŠ¨é‡Šæ”¾èµ„æº</strong>ã€‚</p>
<h3 id="ç§»åŠ¨æ„é€ å‡½æ•°ç§»åŠ¨èµ‹å€¼è¯­å¥">
  ç§»åŠ¨æ„é€ å‡½æ•°&amp;ç§»åŠ¨èµ‹å€¼è¯­å¥
  <a href="#%e7%a7%bb%e5%8a%a8%e6%9e%84%e9%80%a0%e5%87%bd%e6%95%b0%e7%a7%bb%e5%8a%a8%e8%b5%8b%e5%80%bc%e8%af%ad%e5%8f%a5" class="h-anchor" aria-hidden="true">#</a>
</h3>
<ul>
<li>ç§»åŠ¨æ„é€ å‡½æ•°</li>
</ul>
<p>åªéœ€è¦åœ¨æ„é€ å‡½æ•°ä¸­å°†<code>that</code>ä¸­çš„èµ„æºç§»åŠ¨åˆ°<code>this</code>ä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>std<span style="color:#f92672">::</span>swap(<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>bpm_, that.bpm_);
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>swap(<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>page_, that.page_);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>is_dirty_ <span style="color:#f92672">=</span> that.is_dirty_;
</span></span></code></pre></div><p>ä½¿ç”¨: <code>BasicPageGuard a = BasicPageGuard(std::move(b))</code></p>
<ul>
<li>ç§»åŠ¨èµ‹å€¼è¯­å¥</li>
</ul>
<p>å…ˆé‡Šæ”¾å½“å‰å¯¹è±¡å¯¹<code>Buffer Pool</code>çš„å ç”¨ï¼Œå†å°†<code>that</code>ä¸­çš„èµ„æºç§»åŠ¨åˆ°<code>this</code>ä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Drop();
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>swap(<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>bpm_, that.bpm_);
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>swap(<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>page_, that.page_);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>is_dirty_ <span style="color:#f92672">=</span> that.is_dirty_;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>;
</span></span></code></pre></div><p>ä½¿ç”¨: <code>BasicPageGuard a = std::move(b)</code></p>
<blockquote>
<p>åœ¨ReadPageGuard/WritePageGuardçš„ç§»åŠ¨èµ‹å€¼è¯­å¥ä¸­ï¼Œé™¤äº†è°ƒç”¨<code>UnpinPage</code>æ–¹æ³•è¿˜éœ€è¦é‡Šæ”¾è‡ªå·±æŒæœ‰çš„é”ã€‚</p>
</blockquote>
<h3 id="ææ„å‡½æ•°drop">
  ææ„å‡½æ•°&amp;Drop
  <a href="#%e6%9e%90%e6%9e%84%e5%87%bd%e6%95%b0drop" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>ææ„å‡½æ•°åªä¼šè°ƒç”¨<code>Drop</code>å‡½æ•°ï¼Œ<code>Drop</code>å‡½æ•°ï¼Œå¯èƒ½è¢«éšå¼çš„è°ƒç”¨(ææ„å‡½æ•°)ï¼Œä¹Ÿå¯èƒ½è¢«æ˜¾ç¤ºçš„è°ƒç”¨(ç›´æ¥è°ƒç”¨<code>Drop</code>å‡½æ•°)ã€‚æ‰€ä»¥é¿å…é‡å¤é‡Šæ”¾ä»¥åŠç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œå…ˆåˆ¤æ–­è‡ªå·±çš„èµ„æºæ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºåˆ™è°ƒç”¨<code>UnpinPage</code>æ–¹æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (bpm_ <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span> <span style="color:#f92672">&amp;&amp;</span> page_ <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>bpm_<span style="color:#f92672">-&gt;</span>UnpinPage(page_<span style="color:#f92672">-&gt;</span>GetPageId(), is_dirty_);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>bpm_ <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>page_ <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span></code></pre></div><blockquote>
<p>åœ¨<code>ReadPageGuard</code>/<code>WritePageGuard</code>çš„<code>Drop</code>å‡½æ•°ä¸­ï¼Œé™¤äº†è°ƒç”¨<code>UnpinPage</code>æ–¹æ³•è¿˜éœ€è¦é‡Šæ”¾è‡ªå·±æŒæœ‰çš„é”ã€‚</p>
</blockquote>
<h3 id="upgradereadupgradewrite">
  UpgradeRead&amp;UpgradeWrite
  <a href="#upgradereadupgradewrite" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>å°†<code>BasicPageGuard</code>å‡çº§ä¸º<code>ReadPageGuard</code>æˆ–<code>WritePageGuard</code>ã€‚</p>
<ol>
<li>å¯¹é¡µé¢ä¸Šé”</li>
<li>åˆ›å»º<code>ReadPageGuard</code>/<code>WritePageGuard</code></li>
<li>é‡Šæ”¾æœ¬èº«èµ„æº</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> BasicPageGuard<span style="color:#f92672">::</span>UpgradeRead() <span style="color:#f92672">-&gt;</span> ReadPageGuard {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (page_ <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>    page_<span style="color:#f92672">-&gt;</span>RLatch();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span> read_page_guard <span style="color:#f92672">=</span> ReadPageGuard(bpm_, page_);
</span></span><span style="display:flex;"><span>  bpm_ <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>  page_ <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> read_page_guard;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="å¯æ‰©å±•å“ˆå¸Œé¡µé¢å®ç°">
  å¯æ‰©å±•å“ˆå¸Œé¡µé¢å®ç°
  <a href="#%e5%8f%af%e6%89%a9%e5%b1%95%e5%93%88%e5%b8%8c%e9%a1%b5%e9%9d%a2%e5%ae%9e%e7%8e%b0" class="h-anchor" aria-hidden="true">#</a>
</h2>
<h3 id="headeré¡µå®ç°">
  Headeré¡µå®ç°
  <a href="#header%e9%a1%b5%e5%ae%9e%e7%8e%b0" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>ğŸ”—ä»£ç é“¾æ¥ï¼š<a href="https://gitee.com/cnyuyang/bustub/blob/master/src/storage/page/extendible_htable_header_page.cpp" target="_blank">https://gitee.com/cnyuyang/bustub/blob/master/src/storage/page/extendible_htable_header_page.cpp</a>
</p>
<p><img src="/images/15445/lab2-01.png" alt=""></p>
<p>è¿™ä¸ªé¡µé¢çš„ä¸»è¦ä½œç”¨ï¼Œå°±æ˜¯æ ¹æ®è®¡ç®—å‡ºæ¥çš„<code>hash</code>å€¼ï¼Œç´¢å¼•åˆ°å¯¹åº”å­˜å‚¨é¡µé¢ã€‚è¯¥ç±»ä¸­çš„æ•°æ®åŒ…æ‹¬ï¼š</p>
<ul>
<li>
<p><code>directory_page_ids_</code>ï¼šä¿å­˜<code>directory</code>é¡µé¢çš„<code>page_id</code></p>
</li>
<li>
<p><code>max_depth_</code>ï¼š<code>header</code>é¡µèƒ½å¤„ç†çš„æœ€å¤§çš„æ·±åº¦ï¼Œå†³å®šèƒ½ç´¢å¼•çš„<code>directory</code>é¡µé¢çš„æœ€å¤§å¤§å°ã€‚</p>
</li>
</ul>
<p>éœ€è¦å®ç°çš„æ–¹æ³•ï¼š</p>
<ul>
<li>
<p><code>Init</code>ï¼šåˆå§‹åŒ–ï¼Œå¾€<code>directory_page_ids_</code>ä¼šç”¨åˆ°çš„åŒºåŸŸå¡«å……éæ³•<code>page_id</code>-<code>INVALID_PAGE_ID</code>ï¼Œä»£è¡¨æœªåˆ†é…ã€‚</p>
</li>
<li>
<p><code>MaxSize</code>ï¼šèƒ½ç´¢å¼•çš„<code>directory</code>é¡µé¢çš„æœ€å¤§å¤§å°ã€‚ç”±<code>max_depth_</code>å†³å®šï¼Œå°±æ˜¯<code>max_depth_</code>ä½æ•°èƒ½è¡¨ç¤ºå¤šå°‘æ•°æ®ï¼ŒåŠ<code>1&lt;&lt;max_depth_</code>ã€‚</p>
</li>
<li>
<p><code>HashToDirectoryIndex</code>ï¼šå…ƒç´ çš„<code>hash</code>å€¼å¯¹åº”çš„<code>directory</code>åœ¨<code>directory_page_ids_</code>æ•°ç»„çš„ä¸‹æ ‡ã€‚å°±æ˜¯å€¼çš„å‰<code>max_depth_</code>ä½ï¼ŒåŠ<code>hash &gt;&gt; (sizeof(uint32_t) * 8 - this-&gt;max_depth_)</code>ã€‚</p>
</li>
<li>
<p><code>GetDirectoryPageId</code>ï¼šè·å–<code>directory</code>é¡µé¢çš„<code>page_id</code>ï¼Œä»æ•°ç»„ä¸­æŸ¥è¯¢ï¼š<code>directory_page_ids_[directory_idx]</code>ã€‚</p>
</li>
<li>
<p><code>SetDirectoryPageId</code>ï¼šè®¾ç½®<code>directory</code>é¡µé¢çš„<code>page_id</code>ï¼ŒåŠè®¾ç½®æ•°ç»„ï¼š<code>directory_page_ids_[directory_idx] = directory_page_id</code>ã€‚</p>
</li>
</ul>
<h3 id="directoryé¡µå®ç°">
  Directoryé¡µå®ç°
  <a href="#directory%e9%a1%b5%e5%ae%9e%e7%8e%b0" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>ğŸ”—ä»£ç é“¾æ¥ï¼š<a href="https://gitee.com/cnyuyang/bustub/blob/master/src/storage/page/extendible_htable_directory_page.cpp" target="_blank">https://gitee.com/cnyuyang/bustub/blob/master/src/storage/page/extendible_htable_directory_page.cpp</a>
</p>
<p><img src="/images/15445/lab2-02.png" alt=""></p>
<p>è¿™ä¸ªé¡µé¢çš„ä¸»è¦ä½œç”¨ï¼Œä¸€æ–¹é¢æ˜¯ç´¢å¼•åˆ°å­˜å‚¨æ•°æ®çš„<code>bucket</code>é¡µé¢ï¼Œä¸€æ–¹é¢æ˜¯ç»´æŠ¤å…¨å±€åŠ<code>bucket</code>é¡µé¢çš„<strong>åº¦</strong>ã€‚è¯¥ç±»å­˜å‚¨çš„æ•°æ®åŒ…æ‹¬ï¼š</p>
<ul>
<li>
<p><code>max_depth_</code>ï¼šåº¦å¯ç”¨æœ€å¤§çš„æ·±åº¦</p>
</li>
<li>
<p><code>global_depth_</code>ï¼šå…¨å±€çš„åº¦</p>
</li>
<li>
<p><code>local_depths_</code>ï¼šæ¯ä¸ª<code>bucket</code>é¡µé¢çš„åº¦</p>
</li>
<li>
<p><code>bucket_page_ids_</code>ï¼šä¿å­˜<code>bucket</code>é¡µé¢çš„<code>page_id</code></p>
</li>
</ul>
<p>éœ€è¦å®ç°çš„æ–¹æ³•ï¼š</p>
<ul>
<li>
<p><code>Init</code>ï¼šåˆå§‹åŒ–ï¼Œ<code>local_depths_</code>ä¸­å¡«å……åˆå§‹çš„åº¦(0)ï¼Œ<code>bucket_page_ids_</code>ä¸­å¡«å……åˆå§‹éæ³•<code>page_id</code>-<code>INVALID_PAGE_ID</code>ï¼Œä»£è¡¨æœªåˆ†é…ã€‚</p>
</li>
<li>
<p><code>MaxSize</code>ï¼šè¿”å›èƒ½æœ€å¤šç®¡ç†çš„<code>bucket</code>æ•°é‡ï¼ŒåŠ<code>1 &lt;&lt; max_depth_</code>ã€‚</p>
</li>
<li>
<p><code>Size</code>ï¼šå½“å‰èƒ½ç®¡ç†<code>bucket</code>æ•°é‡ï¼ŒåŠ<code>1 &lt;&lt; global_depth_</code></p>
</li>
<li>
<p><code>GetLocalDepth</code>ã€<code>SetLocalDepth</code>ã€<code>IncrLocalDepth</code>ã€<code>DecrLocalDepth</code>ï¼šå¯¹<code>bucket</code>é¡µé¢çš„åº¦çš„ç®¡ç†ï¼Œæ ¹æ®æ•°ç»„ä¸‹æ ‡æ“ä½œ<code>local_depths_</code>æ•°ç»„ã€‚</p>
</li>
<li>
<p><code>GetBucketPageId</code>ã€<code>SetBucketPageId</code>ï¼šå¯¹<code>bucket</code>é¡µé¢çš„<code>page_id</code>çš„ç®¡ç†ï¼Œæ ¹æ®æ•°ç»„ä¸‹æ ‡æ“ä½œ<code>bucket_page_ids_</code>æ•°ç»„ã€‚</p>
</li>
<li>
<p><code>GetGlobalDepthMask</code>ã€<code>HashToBucketIndex</code>ï¼šæ©ç (111&hellip;.111)ï¼š<code>global_depth_</code>ä¸ª1ã€<code>hash &amp; mark</code>å°±æ˜¯è¦å­˜å‚¨çš„<code>bucket</code>çš„ä¸‹æ ‡ã€‚</p>
</li>
<li>
<p><code>IncrGlobalDepth</code>ï¼šå¢åŠ å…¨å±€çš„åº¦ï¼Œè¯¥å‡½æ•°è¦å®ç°çš„æ˜¯ï¼š</p>
<ol>
<li><code>bucket_page_ids_</code>ï¼Œ<code>local_depths_</code>ï¼Œæ•°ç»„æ‰©å®¹ä¸€å€ï¼Œå†…å®¹å…ˆå¤åˆ¶ä¹‹å‰çš„</li>
<li><code>global_depth_++</code>
<img src="/images/15445/lab2-03.png" alt=""></li>
</ol>
</li>
</ul>
<blockquote>
<p>æ‹†åˆ†æ»¡äº†çš„<code>bucket</code>çš„å‰ç½®å‡†å¤‡</p>
</blockquote>
<ul>
<li>
<p><code>GetSplitImageIndex</code>ï¼šè·å–éœ€è¦è¢«æ‹†åˆ†çš„<code>bucket</code>çš„ï¼Œå¦ä¸€ä¸ªç”¨äºå­˜å‚¨æ–°<code>bucket</code>çš„æ•°ç»„ç´¢å¼•ã€‚åŠä¸Šå›¾ä¸­çš„ç´«è‰²ç´¢å¼•ã€‚</p>
</li>
<li>
<p><code>CanShrink</code>ï¼šæ˜¯å¦å¯ä»¥æ”¶ç¼©ï¼Œå½“æ‰€æœ‰<code>bucket</code>çš„åº¦ï¼Œå°äºå…¨å±€çš„åº¦<code>global_depth_</code>æ˜¯å¯ä»¥æ”¶ç¼©ã€‚</p>
</li>
<li>
<p><code>DecrGlobalDepth</code>ï¼šå‡å°å…¨å±€çš„åº¦ï¼Œç›´æ¥<code>global_depth_--</code>ã€‚</p>
</li>
</ul>
<h3 id="bucketé¡µå®ç°">
  Bucketé¡µå®ç°
  <a href="#bucket%e9%a1%b5%e5%ae%9e%e7%8e%b0" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>ğŸ”—ä»£ç é“¾æ¥ï¼š<a href="https://gitee.com/cnyuyang/bustub/blob/master/src/storage/page/extendible_htable_bucket_page.cpp" target="_blank">https://gitee.com/cnyuyang/bustub/blob/master/src/storage/page/extendible_htable_bucket_page.cpp</a>
</p>
<p><img src="/images/15445/lab2-04.png" alt=""></p>
<p>è¯¥é¡µé¢ç”¨äºå®é™…å­˜å‚¨<code>key</code>ã€<code>value</code>çš„æ•°æ®ï¼Œé¡µé¢ä¸­å­˜åœ¨çš„æ•°æ®åŒ…æ‹¬;</p>
<ul>
<li>
<p><code>size_</code>ï¼šå½“å‰å­˜å‚¨çš„<code>kv</code>æ•°é‡ã€‚</p>
</li>
<li>
<p><code>max_size_</code>ï¼šèƒ½å­˜å‚¨æœ€å¤šçš„<code>kv</code>æ•°é‡ã€‚</p>
</li>
<li>
<p><code>array_</code>ï¼šä¿å­˜<code>kv</code>çš„æ•°ç»„</p>
</li>
</ul>
<p>è¯¥é¡µé¢è¦å®ç°çš„å‡½æ•°ï¼š</p>
<ul>
<li>
<p><code>Lookup</code>ï¼šæ ¹æ®<code>key</code>æŸ¥æ‰¾<code>value</code>ï¼ŒåŠéå†<code>array_</code>æ•°ç»„</p>
</li>
<li>
<p><code>Insert</code>ï¼šå¦‚æœè¯¥<code>bucket</code>æ»¡äº†ï¼Œç›´æ¥æŠ¥é”™ã€‚å¦‚æœ<code>key</code>å·²ç»å­˜åœ¨ï¼Œç›´æ¥æŠ¥é”™ã€‚æ’åœ¨æ•°ç»„çš„æœ€åã€‚</p>
</li>
<li>
<p><code>Remove</code>ï¼šæ ¹æ®<code>key</code>æŸ¥æ‰¾æ•°ç»„ä¸­å­˜å‚¨çš„ä½ç½®ï¼Œå°†åé¢çš„å…ƒç´ å¾€å‰ç§»åŠ¨ä¸€ä¸ªä½ç½®ã€‚</p>
</li>
</ul>
<h2 id="å¯æ‰©å±•å“ˆå¸Œå®ç°">
  å¯æ‰©å±•å“ˆå¸Œå®ç°
  <a href="#%e5%8f%af%e6%89%a9%e5%b1%95%e5%93%88%e5%b8%8c%e5%ae%9e%e7%8e%b0" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>ğŸ”—ä»£ç é“¾æ¥ï¼š<a href="https://gitee.com/cnyuyang/bustub/blob/master/src/container/disk/hash/disk_extendible_hash_table.cpp" target="_blank">https://gitee.com/cnyuyang/bustub/blob/master/src/container/disk/hash/disk_extendible_hash_table.cpp</a>
</p>
<p>è¯¥å®ç°éœ€è¦ä½¿ç”¨ä¸Šé¢ç« èŠ‚å®ç°çš„å„ç±»å¯æŒä¹…åŒ–é¡µé¢ã€‚ç›¸å…³å‡½æ•°å®ç°ï¼š</p>
<ul>
<li>
<p><code>DiskExtendibleHashTable</code>ï¼šæ„é€ å‡½æ•°ï¼Œä»<code>Buffer Pool</code>ä¸­ç”³è¯·ä¸€ä¸ªé¡µé¢ï¼Œè°ƒç”¨<code>Header</code>é¡µé¢çš„åˆå§‹åŒ–æ¥å£ã€‚</p>
</li>
<li>
<p><code>GetValue</code>ï¼šé€šè¿‡<code>key</code>æŸ¥æ‰¾å€¼ã€‚ä¸€å±‚ä¸€å±‚çš„æŸ¥æ‰¾ï¼Œé€šè¿‡<code>Header</code>é¡µé¢æŸ¥æ‰¾å¯¹åº”çš„<code>Directory</code>é¡µé¢ï¼Œå†é€šè¿‡<code>Directory</code>é¡µé¢æŸ¥æ‰¾<code>Bucket</code>é¡µé¢ã€‚æœ€åè°ƒç”¨<code>Bucket</code>é¡µé¢çš„<code>Lookup</code>å‡½æ•°ã€‚ä¸­é—´ä»»æ„ä¸€å¤„æ²¡æœ‰æŸ¥æ‰¾åˆ°åˆ™è®¤ä¸ºä¸å­˜åœ¨ã€‚</p>
</li>
</ul>
<p><img src="/images/15445/06-17.png" alt=""></p>
<ul>
<li><code>Insert</code>ï¼šæ’å…¥é”®å€¼å¯¹ã€‚å’Œ<code>GetValue</code>å‡½æ•°ç±»ä¼¼ï¼Œä¸€å±‚ä¸€å±‚æŸ¥æ‰¾åˆ°<code>Bucket</code>é¡µé¢ï¼Œè¿›è¡Œæ’å…¥ã€‚
<ul>
<li>è‹¥<code>Directory</code>é¡µé¢æˆ–è€…<code>Bucket</code>é¡µé¢æ­¤å‰æ²¡æœ‰ï¼Œåˆ™æ–°ç”³è¯·é¡µé¢å†è¿›è¡Œæ’å…¥ã€‚</li>
<li>è‹¥<code>Bucket</code>é¡µé¢å·²æ»¡ï¼Œåˆ™è¿›è¡Œ<code>Bucket</code>é¡µé¢çš„æ‹†åˆ†ï¼Œå†é€’å½’è°ƒç”¨è¯¥å‡½æ•°</li>
</ul>
</li>
</ul>
<p><img src="/images/15445/06-18.png" alt=""></p>
<blockquote>
<p><code>Bucket</code>é¡µé¢èƒ½è¿›è¡Œæ‹†åˆ†åˆ¤æ–­æ¡ä»¶ï¼š</p>
<ol>
<li>
<p>å½“å‰<code>Bucket</code>é¡µé¢çš„åº¦æ¯”å…¨å±€çš„åº¦å°ï¼Œè¿™ä¸ªæ—¶å€™åªéœ€è¦å¯¹<code>Bucket</code>é¡µé¢çš„åº¦è¿›è¡Œ<code>+1</code>æ“ä½œ</p>
</li>
<li>
<p>å½“å‰å…¨å±€çš„åº¦å°äº<code>Directory</code>é¡µé¢èƒ½å¤„ç†æœ€å¤§çš„åº¦ã€‚è¿™ä¸ªæƒ…å†µåˆ™éœ€è¦å¯¹<code>Directory</code>é¡µé¢å…¨å±€çš„åº¦å’Œ<code>Bucket</code>é¡µé¢çš„åº¦åŒæ—¶è¿›è¡Œ<code>+1</code>æ“ä½œ</p>
</li>
</ol>
</blockquote>
<ul>
<li><code>SplitBucket</code>ï¼šè¯¥å‡½æ•°ä¸ºè‡ªå·±æ–°åŠ çš„ï¼Œç”¨äºæ¡¶æ‹†åˆ†ã€‚å› ä¸ºåº¦çš„å˜åŒ–å·²ç»åœ¨<code>Insert</code>å‡½æ•°ä¸­åšäº†ï¼Œæ‰€ä»¥æœ¬å‡½æ•°éœ€è¦å®ç°ç”³è¯·æ–°æ¡¶ï¼Œæ›¿æ¢åˆ°æ–°ä½ç½®ï¼Œç„¶åè¿›è¡Œæ¡¶çš„æ‹†åˆ†ã€‚å°†åŸæ¥æ¡¶ä¸­çš„å…ƒç´ é‡æ–°hashåˆ†é…ã€‚</li>
</ul>
<p><img src="/images/15445/06-19.png" alt=""></p>
<ul>
<li><code>Remove</code>ï¼šç§»é™¤é”®å€¼å¯¹ã€‚å’Œ<code>GetValue</code>å‡½æ•°ç±»ä¼¼ï¼Œä¸€å±‚ä¸€å±‚æŸ¥æ‰¾åˆ°<code>Bucket</code>é¡µé¢ï¼Œè¿›è¡Œåˆ é™¤æ“ä½œã€‚</li>
</ul>
<blockquote>
<p>@Todo è¿™é‡Œæ²¡æœ‰å®ç°ï¼Œå“ˆå¸Œè¡¨çš„æ”¶ç¼©ã€‚</p>
</blockquote>
<h2 id="å¹¶å‘æ§åˆ¶">
  å¹¶å‘æ§åˆ¶
  <a href="#%e5%b9%b6%e5%8f%91%e6%8e%a7%e5%88%b6" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>åœ¨<code>Lecture#9 Index Concurrency Control</code>è¯¾ä¸­å­¦ä¹ åˆ°ï¼Œå¯¹å“ˆå¸Œè¡¨çš„æ·é”æœ‰ä¸¤ç§å½¢å¼ï¼šå¯¹<code>page</code>é¡µåŠ é”ã€å¯¹<code>solt</code>æ§½ä½æ·é”ã€‚</p>
<p><strong>æ–¹æ¡ˆä¸€ï¼šå¯¹pageé¡µåŠ é”</strong></p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¦‚æœé”çš„ç²’åº¦æ˜¯é’ˆå¯¹pageé¡µè¿›è¡Œçš„ã€‚é‚£ä¹ˆçº¿ç¨‹1è·å–äº†æ•´ä¸ªpageé¡µçš„è¯»é”ï¼Œçº¿ç¨‹2è·å–çº¿ç¨‹1æ‰€åœ¨æ§½ä½ä¸‹æ–¹çš„æ§½ä½çš„å†™é”æ—¶å€™ä¹Ÿéœ€è¦è¿›è¡Œç­‰å¾…ã€‚</p>
<p><img src="/images/15445/09-01.png" alt=""></p>
<p><strong>æ–¹æ¡ˆäºŒï¼šå¯¹soltæ§½ä½åŠ é”</strong></p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¿ç¨‹1åªè·å–Aæ‰€åœ¨æ§½ä½çš„è¯»é”ï¼Œä¸ä¼šå½±å“çº¿ç¨‹2è·å–Cæ‰€åœ¨æ§½ä½çš„å†™é”ã€‚</p>
<p><img src="/images/15445/09-02.png" alt=""></p>
<p>åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œåªè¦æˆ‘ä»¬çš„ä»<code>Buffr Pool</code>ä¸­è·å–ã€ç”³è¯·é¡µé¢çš„ä½¿ç”¨è°ƒç”¨å¸¦æœ‰<code>Guard</code>çš„å®‰å…¨å‡½æ•°ï¼ŒæŒ‰ç…§ä¹‹å‰çš„å®ç°ï¼Œæˆ‘ä»¬å°±èƒ½å®ç°æ–¹æ¡ˆä¸€é¡µé¢çº§åˆ«çš„å¹¶å‘æ§åˆ¶ã€‚</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://yuyang.run/posts/cmu15-445%E5%AE%9E%E9%AA%8C/bustub%E4%B8%AD%E4%BD%BF%E7%94%A8%E7%9A%84%E4%B8%89%E6%96%B9%E4%BB%B6-linenoise/">
                  <span class="button__icon">â†</span>
                  <span class="button__text">BusTubä¸­ä½¿ç”¨çš„ä¸‰æ–¹ä»¶-linenoise</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://yuyang.run/posts/cmu15-445%E5%AE%9E%E9%AA%8C/bustub%E5%B7%B2%E5%AE%9E%E7%8E%B0%E9%83%A8%E5%88%86/">
                  <span class="button__text">BusTubå·²å®ç°éƒ¨åˆ†</span>
                  <span class="button__icon">â†’</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </article>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="https://yuyang.run"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >ä½™ä¸ºæ°‘åŒå¿—</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span>Â© 2024 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span><a href="https://github.com/panr/hugo-theme-hello-friend" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
    
  </div>
</footer>





<script type="text/javascript" src="/bundle.min.js"></script>


      
    </div>

    
  </body>
</html>
